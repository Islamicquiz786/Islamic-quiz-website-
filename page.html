<!doctype html>
<html lang="en">    
<head>    
  <meta charset="UTF-8">    
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">    
  <title>Islamic Quiz Earning Platform - Complete Registration</title>    
  <link rel="preconnect" href="https://fonts.googleapis.com">  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>  
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">  
  <style>    
    * {    
      margin: 0;    
      padding: 0;    
      box-sizing: border-box;    
      font-family: 'Orbitron', sans-serif;    
    }    
    body, html {  
      height: 100%;  
      width: 100%;  
      overflow-x: hidden;  
    }  
      
    body {    
      min-height: 100vh;  
      background: url('https://github.com/Islamicquiz786/Sahil-Images-/raw/main/ee4300b6-1a52-426c-97e2-634d0ca398a7.jpeg') no-repeat center center fixed;    
      background-size: cover;    
      display: flex;    
      justify-content: center;    
      align-items: center;    
      position: relative;    
    }    

    .overlay {    
      position: absolute;    
      inset: 0;    
      background: rgba(0, 0, 0, 0.65);    
      backdrop-filter: blur(10px);    
      z-index: 1;    
    }    

    .register-box {    
      position: relative;    
      z-index: 10;    
      background: rgba(255, 255, 255, 0.05);    
      border: 2px solid rgba(255, 255, 255, 0.2);    
      border-radius: 20px;    
      padding: 25px;    
      width: 95%;  
      max-width: 400px;  
      box-shadow: 0 0 25px #00ffe5;    
      animation: glow 3s infinite alternate;    
      margin: 20px 0;  
    }    

    @keyframes glow {    
      from { box-shadow: 0 0 15px #00ffe5; }    
      to { box-shadow: 0 0 30px #00ffe5, 0 0 60px #00ffe5; }    
    }    

    .register-box h2 {    
      color: #00ffe5;    
      text-align: center;    
      margin-bottom: 20px;    
      text-shadow: 0 0 10px #00ffe5;    
      font-size: 1.5rem;  
    }    

    .register-box input,    
    .register-box select {    
      width: 100%;    
      margin-bottom: 15px;    
      padding: 12px;    
      border: none;    
      border-radius: 8px;    
      background: rgba(255, 255, 255, 0.1);    
      color: #fff;    
      font-size: 14px;    
      transition: 0.3s;    
    }    

    .register-box input::placeholder {    
      color: #ccc;    
    }    

    .register-box input:focus,    
    .register-box select:focus {    
      outline: none;    
      background: rgba(255, 255, 255, 0.2);    
      box-shadow: 0 0 10px #00ffe5;    
    }    

    .register-box button {    
      width: 100%;    
      padding: 12px;    
      font-size: 16px;    
      background: #00ffe5;    
      color: #000;    
      border: none;    
      border-radius: 8px;    
      cursor: pointer;    
      box-shadow: 0 0 15px #00ffe5, 0 0 40px #00ffe5 inset;    
      transition: 0.3s ease-in-out;    
      margin-top: 10px;  
    }    

    .register-box button:hover {    
      background: #000;    
      color: #00ffe5;    
      box-shadow: 0 0 20px #00ffe5, 0 0 60px #00ffe5 inset;    
    }    

    .register-box label {    
      color: #00ffe5;    
      font-size: 14px;    
      margin-bottom: 6px;    
      display: block;    
      text-shadow: 0 0 5px #00ffe5;    
    }    

    .error-message {    
      color: #ff4b4b;    
      font-size: 12px;    
      text-align: center;    
      margin-top: -10px;    
      margin-bottom: 10px;    
      text-shadow: 0 0 5px #ff0000;    
      display: none;    
    }    

    .success-message {    
      color: #39ff14;    
      text-align: center;    
      margin-bottom: 15px;    
      text-shadow: 0 0 5px #39ff14;    
      display: none;    
      font-size: 14px;  
      line-height: 1.4;  
    }    

    .login-link {    
      text-align: center;    
      margin-top: 20px;    
      font-size: 14px;    
      color: #00ffe5;    
    }    

    .login-link a {    
      color: #39ff14;    
      font-weight: bold;    
      text-decoration: none;    
      text-shadow: 0 0 5px #39ff14;    
    }  

    .back-link {    
      text-align: center;    
      margin-top: 20px;    
      font-size: 14px;    
      color: #00ffe5;    
    }    

    .back-link a {    
      color: #39ff14;    
      font-weight: bold;    
      text-decoration: none;    
      text-shadow: 0 0 5px #39ff14;    
    }  
      
    .islamic-verse {  
      text-align: center;  
      color: #00ffe5;  
      margin-top: 20px;  
      font-size: 14px;  
      line-height: 1.6;  
      text-shadow: 0 0 5px #00ffe5;  
    }  
      
    .loading {
      color: #00ffe5;
      text-align: center;
      margin: 15px 0;
      text-shadow: 0 0 5px #00ffe5;
      display: none;
      font-size: 14px;
    }
    
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    
    .alert.success {
      background: rgba(57, 255, 20, 0.1);
      border-left: 3px solid #39ff14;
      color: #39ff14;
      text-shadow: 0 0 5px #39ff14;
    }
    
    .resend-link {
      color: #00ffe5;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }
      
    @media (max-width: 480px) {  
      .register-box {  
        padding: 20px 15px;  
      }  
        
      .register-box h2 {  
        font-size: 1.3rem;  
      }  
        
      .register-box input,  
      .register-box select {  
        padding: 10px;  
        font-size: 13px;  
      }  
    }
  </style>    
</head>    
<body>    
  <div class="overlay"></div>    
  <div class="register-box">    
    <h2>Complete Registration</h2>    
    <div id="successMessage" class="success-message"></div>    
    <div id="verificationAlert" class="alert success"></div>
    <form id="completeForm">    
      <label for="password">Password (1-10 Characters)</label>    
      <input type="password" id="password" minlength="1" maxlength="10" required placeholder="Enter password (1-10 characters)">    
      <div id="passwordError" class="error-message"></div>    
      
      <label for="email">Email (Gmail)</label>    
      <input type="email" id="email" required placeholder="Enter your Gmail">    
      <div id="emailError" class="error-message"></div>    
      
      <button type="submit">Complete Registration</button>    
      <div id="loading" class="loading">‚è≥ Please wait... Submitting your registration.</div>
    </form>    
    <div class="back-link">    
      <a href="register.html">‚Üê Back to Previous Step</a>    
    </div>
    <div class="login-link">    
      Already have an account? <a href="index.html">Login Here</a>    
    </div>  
    <div class="islamic-verse">  
      Ô¥ø ŸàŸéŸÇŸèŸÑŸí ÿ±Ÿéÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß Ô¥æ<br>  
      ÿßŸàÿ± ÿØÿπÿß ⁄©ÿ±Ÿà: ÿß€í ŸÖ€åÿ±€í ÿ±ÿ®! ŸÖ€åÿ±€í ÿπŸÑŸÖ ŸÖ€å⁄∫ ÿßÿ∂ÿßŸÅ€Å ŸÅÿ±ŸÖÿß€î<br>  
      (ÿ≥Ÿàÿ±€É ÿ∑Ÿ∞€ÅŸ∞ - ÿ¢€åÿ™ 114)  
    </div>
  </div>    

  <!-- Firebase Integration -->        
  <script type="module">    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";    
    import {   
      getAuth,   
      createUserWithEmailAndPassword,   
      sendEmailVerification,
      onAuthStateChanged,
      applyActionCode
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";    
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";    
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";    
  
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBasuAzvAlaVAayEdDU9bB9wvUzG7fVuAg",
      authDomain: "islamic-quiz-website.firebaseapp.com",
      databaseURL: "https://islamic-quiz-website-default-rtdb.firebaseio.com",
      projectId: "islamic-quiz-website",
      storageBucket: "islamic-quiz-website.appspot.com",
      messagingSenderId: "517259698394",
      appId: "1:517259698394:web:36094d03187da81685e3"
    };

    try {
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);    
      const auth = getAuth(app);    
      const database = getDatabase(app);    
      const storage = getStorage(app);    
  
      // Check if we have registration data
      const registrationData = JSON.parse(localStorage.getItem('registrationData'));
      if (!registrationData) {
        window.location.href = "register.html";
      }

      // Check URL for email verification action
      const urlParams = new URLSearchParams(window.location.search);
      const actionCode = urlParams.get('oobCode');
      const mode = urlParams.get('mode');
      
      if (actionCode && mode === 'verifyEmail') {
        try {
          document.getElementById('loading').style.display = 'block';
          document.getElementById('completeForm').style.display = 'none';
          
          await applyActionCode(auth, actionCode);
          
          // Update email verification status in database
          const user = auth.currentUser;
          if (user) {
            await update(ref(database, 'users/' + user.uid), {
              emailVerified: true
            });
            
            document.getElementById("verificationAlert").innerHTML = `
              ‚úÖ Email verified successfully! <br>
              ‚è≥ Your account is pending admin approval. <br>
              üì© You'll receive an email when your account is activated.
            `;
            document.getElementById("verificationAlert").style.display = "block";
          }
        } catch (error) {
          console.error("Email verification error:", error);
          document.getElementById("verificationAlert").innerHTML = `
            ‚ùå Email verification failed! <br>
            ${error.message} <br>
            Please try again or contact support.
          `;
          document.getElementById("verificationAlert").style.display = "block";
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      }

      // Check verification status and admin approval
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Check if user is verified and approved by admin
          const userRef = ref(database, 'users/' + user.uid);
          onValue(userRef, (snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              if (user.emailVerified && userData.status === "approved") {
                // Redirect to dashboard if approved
                window.location.href = "dashboard.html";
              } else if (user.emailVerified) {
                // Show message that admin approval is pending
                document.getElementById("completeForm").style.display = "none";
                document.getElementById("verificationAlert").innerHTML = `
                  ‚úÖ Email verified successfully! <br>
                  ‚è≥ Your account is pending admin approval. <br>
                  üì© You'll receive an email when your account is activated.
                `;
                document.getElementById("verificationAlert").style.display = "block";
              }
            }
          }, { onlyOnce: false });
        }
      });

      // Real-time validation for password (1-10 characters)  
      document.getElementById('password').addEventListener('input', function(e) {  
        if (this.value.length > 10) {  
          this.value = this.value.slice(0, 10);  
          document.getElementById('passwordError').textContent = 'Password must be 1-10 characters';  
          document.getElementById('passwordError').style.display = 'block';  
        } else {  
          document.getElementById('passwordError').style.display = 'none';  
        }  
      });  
  
      document.getElementById("completeForm").addEventListener("submit", async (e) => {    
        e.preventDefault();    
            
        // Reset error messages    
        document.querySelectorAll('.error-message').forEach(el => {    
          el.style.display = 'none';    
          el.textContent = '';    
        });    
            
        // Get form values    
        const password = document.getElementById("password").value;    
        const email = document.getElementById("email").value.trim();    
        const registrationData = JSON.parse(localStorage.getItem('registrationData'));    
        const screenshotBase64 = localStorage.getItem('paymentScreenshot');    
            
        // Validate password (1-10 characters)  
        if (password.length < 1 || password.length > 10) {  
          document.getElementById("passwordError").textContent = "Password must be 1-10 characters";  
          document.getElementById("passwordError").style.display = "block";  
          return;  
        }  
            
        try {    
          // Show loading message
          document.getElementById('loading').style.display = 'block';
          document.querySelector('#completeForm button[type="submit"]').style.display = 'none';
          
          // Create user with Firebase Auth    
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);    
          const user = userCredential.user;    
              
          // Send email verification with proper settings
          await sendEmailVerification(user, {
            handleCodeInApp: true,
            url: window.location.origin + window.location.pathname
          });  
              
          // Upload payment screenshot if exists    
          let screenshotUrl = "";    
          if (screenshotBase64 && registrationData.hasScreenshot) {    
            const screenshotBlob = await fetch(screenshotBase64).then(res => res.blob());  
            const screenshotRef = storageRef(storage, `payment_screenshots/${user.uid}/payment_${Date.now()}.jpg`);    
            await uploadBytes(screenshotRef, screenshotBlob);    
            screenshotUrl = await getDownloadURL(screenshotRef);    
          }    
              
          // Save user data to Realtime Database    
          await set(ref(database, 'users/' + user.uid), {    
            username: registrationData.username,    
            email: email,    
            whatsapp: registrationData.whatsapp,    
            plan: registrationData.plan,    
            paymentMethod: registrationData.payment,    
            accountNumber: registrationData.accountNumber || "",    
            accountName: registrationData.accountName || "",    
            paymentScreenshot: screenshotUrl,    
            registrationDate: new Date().toISOString(),    
            status: "pending", // Admin needs to approve
            balance: 0,  
            emailVerified: false  
          });    
              
          // Show verification message    
          document.getElementById("completeForm").style.display = "none";    
          document.getElementById("verificationAlert").innerHTML = `
            üì© Verification link sent to <strong>${email}</strong>! <br><br>
            Please check your inbox (and spam folder) for the verification email. <br><br>
            <span class="resend-link" id="resendLink">Didn't receive email? Resend verification</span>
          `;
          document.getElementById("verificationAlert").style.display = "block";
              
          // Clear stored data
          localStorage.removeItem('registrationData');
          localStorage.removeItem('paymentScreenshot');
          
          // Add resend verification email handler
          document.getElementById('resendLink').addEventListener('click', async () => {
            try {
              document.getElementById('resendLink').textContent = 'Sending...';
              await sendEmailVerification(user, {
                handleCodeInApp: true,
                url: window.location.origin + window.location.pathname
              });
              document.getElementById('resendLink').textContent = 'Verification resent! Check your email.';
            } catch (error) {
              document.getElementById('resendLink').textContent = 'Error sending. Try again.';
              console.error("Resend error:", error);
            }
          });
              
        } catch (error) {    
          console.error("Registration error:", error);  
          let errorMessage = "Registration failed!";    
          switch (error.code) {    
            case "auth/email-already-in-use":    
              errorMessage = "Email is already registered (1 account per email allowed)";    
              document.getElementById("emailError").textContent = errorMessage;    
              document.getElementById("emailError").style.display = "block";    
              break;    
            case "auth/invalid-email":    
              errorMessage = "Invalid email address";    
              document.getElementById("emailError").textContent = errorMessage;    
              document.getElementById("emailError").style.display = "block";    
              break;    
            case "auth/weak-password":    
              errorMessage = "Password must be at least 6 characters";    
              document.getElementById("passwordError").textContent = errorMessage;    
              document.getElementById("passwordError").style.display = "block";    
              break;    
            default:    
              document.getElementById("emailError").textContent = errorMessage + ": " + error.message;    
              document.getElementById("emailError").style.display = "block";    
          }    
          
          // Re-enable submit button if error occurs
          document.getElementById('loading').style.display = 'none';
          document.querySelector('#completeForm button[type="submit"]').style.display = 'block';
        } finally {
          document.getElementById('loading').style.display = 'none';
        }    
      });    

    } catch (error) {
      console.error("Firebase initialization error:", error);
      document.getElementById("emailError").textContent = "System error. Please try again later.";
      document.getElementById("emailError").style.display = "block";
    }
  </script>    
</body>    
</html>
